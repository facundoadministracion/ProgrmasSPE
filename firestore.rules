
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========== Helper Functions ==========
    /**
     * @description Checks if the user is authenticated (not null).
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user has the 'admin' role. It first verifies
     * the user's document exists before checking the role to prevent errors.
     */
    function isAdmin() {
      // Use exists() to prevent errors on non-existent documents.
      return exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // ========== Collection Rules ==========

    /**
     * @description Rules for the user roles collection.
     * This is the definitive fix: A user can ALWAYS create their own profile on signup.
     * A user can ALWAYS read or write their OWN document.
     * An admin can read or write ANY document. This breaks circular dependencies.
     * @path /users/{userId}
     */
     match /users/{userId} {
        allow create: if isSignedIn();
        allow read, update, delete: if isSignedIn() && (request.auth.uid == userId || isAdmin());
    }

    /**
     * @description Authenticated users can read all participant data.
     * Only admins can create, update, or delete participants.
     * @path /artifacts/{appId}/public/data/participants/{participantId}
     */
    match /artifacts/{appId}/public/data/participants/{participantId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    /**
     * @description Authenticated users can read all payment data.
     * Only admins can create payments (typically done via server-side processes).
     * @path /artifacts/{appId}/public/data/payments/{paymentId}
     */
    match /artifacts/{appId}/public/data/payments/{paymentId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    /**
     * @description Authenticated users can read all news items.
     * Any authenticated user can create a news item (e.g., logging a change).
     * Only admins can modify or delete news items.
     * @path /artifacts/{appId}/public/data/novedades/{novedadId}
     */
    match /artifacts/{appId}/public/data/novedades/{novedadId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isAdmin();
    }
    
    /**
     * @description Rules for the 'asistencias' collection.
     * Any authenticated user can create/read/write attendance records.
     */
    match /artifacts/{appId}/public/data/asistencias/{asistenciaId} {
      allow read, write: if isSignedIn();
    }

    /**
     * @description Application configuration is readable by any authenticated user.
     * Configuration is only writable by an admin to prevent tampering.
     * @path /artifacts/{appId}/public/data/config/{configId}
     */
    match /artifacts/{appId}/public/data/config/{configId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }
  }
}
