rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    match /users/{userId} {
      
      function isAdmin() {
        return request.auth != null &&
               request.auth.token.email == "crnunezfacundo@gmail.com";
      }

      // CUALQUIER usuario autenticado puede CREAR su propio documento.
      // Esto es crucial para el flujo de registro.
      allow create: if request.auth != null && request.auth.uid == userId;

      // Un usuario puede leer y actualizar su propio documento.
      allow read, update: if request.auth != null && request.auth.uid == userId;
      
      // Solo el admin puede borrar documentos de usuario.
      allow delete: if isAdmin();

      // El admin puede leer y escribir cualquier documento de usuario.
      allow read, write: if isAdmin();
    }

    // Para el resto de las colecciones, por defecto, solo el admin tiene acceso total.
    // Esto previene lecturas/escrituras no deseadas en otras partes de la base de datos.
    match /participants/{docId} {
       allow read, write: if request.auth != null && request.auth.token.email == "crnunezfacundo@gmail.com";
    }
    match /payments/{docId} {
       allow read, write: if request.auth != null && request.auth.token.email == "crnunezfacundo@gmail.com";
    }
    match /config/{docId} {
       allow read, write: if request.auth != null && request.auth.token.email == "crnunezfacundo@gmail.com";
    }
    match /novedades/{docId} {
       allow read, write: if request.auth != null && request.auth.token.email == "crnunezfacundo@gmail.com";
    }
     match /asistencias/{docId} {
       allow read, write: if request.auth != null && request.auth.token.email == "crnunezfacundo@gmail.com";
    }
  }
}
