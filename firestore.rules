rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Colecci√≥n de usuarios
    match /users/{userId} {
      
      function isAdmin() {
        return request.auth != null &&
               request.auth.token.email == "crnunezfacundo@gmail.com";
      }

      // **REGLA CLAVE**: Cualquier usuario autenticado puede CREAR su propio documento.
      // Esto es crucial para que el proceso de registro funcione.
      allow create: if request.auth != null && request.auth.uid == userId;

      // Un usuario puede leer y actualizar solo su propio documento.
      allow read, update, delete: if request.auth != null && request.auth.uid == userId;

      // El admin tiene permisos totales sobre cualquier documento de usuario.
      allow read, write: if isAdmin();
    }

    // Para el resto de las colecciones, solo el admin tiene acceso.
    // Esto previene lecturas/escrituras no deseadas en otras partes de la base de datos.
    match /participants/{docId} {
       allow read, write: if request.auth != null && request.auth.token.email == "crnunezfacundo@gmail.com";
    }
    match /payments/{docId} {
       allow read, write: if request.auth != null && request.auth.token.email == "crnunezfacundo@gmail.com";
    }
    match /config/{docId} {
       allow read, write: if request.auth != null && request.auth.token.email == "crnunezfacundo@gmail.com";
    }
    match /novedades/{docId} {
       allow read, write: if request.auth != null && request.auth.token.email == "crnunezfacundo@gmail.com";
    }
     match /asistencias/{docId} {
       allow read, write: if request.auth != null && request.auth.token.email == "crnunezfacundo@gmail.com";
    }
  }
}
