
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return request.auth.token.email == "crnunezfacundo@gmail.com";
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // --- Reglas para la colección de Usuarios ---
    // Esta regla debe ir ANTES de la regla general /{document=**}
    match /users/{userId} {
      // REGLA DE CREACIÓN: Permite a un nuevo usuario crear SU PROPIO perfil.
      // Esta es la línea clave que rompe el "círculo vicioso".
      allow create: if isSignedIn() && isOwner(userId);

      // REGLAS DE LECTURA Y ACTUALIZACIÓN: Un usuario puede leer/actualizar su propio perfil.
      allow read, update: if isSignedIn() && isOwner(userId);
      
      // REGLA DE BORRADO: Solo un admin puede borrar perfiles.
      allow delete: if isAdmin();
      
      // EXCEPCIÓN PARA ADMIN: Un admin puede leer y escribir CUALQUIER perfil.
      // Esta regla anula las anteriores si el usuario es admin.
      allow read, write: if isAdmin();
    }
    
    // --- Reglas para el resto de las colecciones (participantes, pagos, etc.) ---
    // El administrador tiene acceso total a todas las demás colecciones.
    // Esta regla general se aplica a cualquier ruta que no coincida con /users/{userId}.
    match /participants/{docId} {
      allow read, write: if isAdmin();
    }
    match /payments/{docId} {
      allow read, write: if isAdmin();
    }
    match /config/{docId} {
      allow read, write: if isAdmin();
    }
    match /novedades/{docId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isAdmin();
    }
    match /asistencias/{docId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isAdmin();
    }
  }
}
